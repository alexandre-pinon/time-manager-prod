steps:
  # Docker Build
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "build",
        "-t",
        "${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/${_API_IMAGE_NAME}:${_TAG}",
        "api",
      ]
    id: "Build api image üî®"
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "build",
        "-t",
        "${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/${_FRONT_IMAGE_NAME}:${_TAG}",
        "front",
      ]
    id: "Build front image üî®"

  # Docker Push
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/${_API_IMAGE_NAME}:${_TAG}",
      ]
    id: "Push api image üöÄ"
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_ARTIFACT_REPO}/${_FRONT_IMAGE_NAME}:${_TAG}",
      ]
    id: "Push front image üöÄ"

  # deploy container image to GKE
  - name: "gcr.io/cloud-builders/gke-deploy"
    args:
      - run
      - --filename=${_PIPELINE_PATH}
      - --location=${_LOCATION}
      - --cluster=${_CLUSTER_NAME}
    id: "Apply deployments ‚úàÔ∏è"

substitutions:
  _PIPELINE_PATH: kubernetes/pipeline.yml
  _CLUSTER_NAME: pr-ftw-cluster
  _LOCATION: europe-west1
  _ARTIFACT_REPO: pr-ftw-repo
  _API_IMAGE_NAME: time-manager-api
  _FRONT_IMAGE_NAME: time-manager-front
  _TAG: "1.2"
